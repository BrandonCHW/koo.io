<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script type="text/javascript" src="listeners.js"></script> -->
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>
    <title>Koo.io</title>
    <style>
        body,html {
            background: lightpink; 
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div style="display:none">
        <h1>Koo.io</h1>
        <div>
            <label for="userId">Your Name: </label>
            <input id="userId" type="text">        
        </div>
        <div>
            <button>Find Lobby</button>
            <button>Create Lobby</button>
        </div>
        <div>
            <button>Rules</button>
        </div>
        <p>Credits: Bred and Chimp, inspired by Rikki Rahta's Coup Original recipe nice</p>
    </div>

    <div>
        <p>Timer: <span id="roundTimer"></span></p>
    </div>
    <!-- Other players data -->
    <div id="otherPlayers">
        <h1>Other Players</h1>
        <div>
            <p>Should not see this</p>
        </div>
    </div>

    <!-- Current player data -->
    <div>
        <h1>Player status</h1>
        <p>My name: <span id="playerName">Chimp</span></p>
        <p>Player Coins: <span id="pCoins">0</span></p>
        <p>Card 1: <span id="pCard1Name">card1</span>; Status: <span id="pCard1Status">Alive</span></p>
        <p>Card 2: <span id="pCard2Name">card2</span>; Status: <span id="pCard2Status">Alive</span></p>
        
    </div>
        
    <!-- Player actions -->
    <div id="actions">
        <h4>Generic</h4>
        <div>
            <button id="income">Income: +1 Coin</button>
            <button id="foreign">Foreign: +2 Coin</button>
            <button id="coup">Coup: -7 Coins</button>
        </div>
        <h4>Special Action</h4>
        <div>
            <button id="tax">Tax: +3 Coins</button>
            <button id="steal">Steal: Yoink (+2 coins)</button>
            <button id="assassinate">Assassinate: Kill (-3 Coins)</button>
            <button id="exchange">Exchange: Take 2 cards, keep 1</button>
        </div>

        <div id="playerSelector" style="display: none;">
            <h4>Intention: <span id="intention">lemheurdheur</span></h4>
            <button onclick="selectPlayer(this)">cartemere</button>
            <button onclick="selectPlayer(this)">ChimpUnleashed</button>
        </div>

    </div>

    <!-- Card Select (Exchange) -->
    <div>

    </div>    

    <script>
        // var a = $("div[id='actions'] div button").on("click", function(btn) {
        //     console.log(btn.target.id)
        // })

        var socket = io()
        
        var playerId = ""
        socket.on('connect',  () => {
            playerId = socket.id
        })

        // called whenever the game state changes (new connection, action)
        socket.on('state change', (payload) => {
            updateOtherPlayersView(payload)
        })
        
        // called when the player bitconnects to the game
        socket.on('self connection', (p) => {
            updatePlayerStatus(p)
        })

        // Receive timer update (regularly updated)
        socket.on('timer', (time) => {
            updateTimer(time)
        })

        //Updates the 'player status' 
        function updatePlayerStatus(p) {
            $("#playerName").text(p.name)
            $("#pCoins").text(p.coins)
            $("#pCard1Name").text(p.firstCard)
            $("#pCard1Status").text(p.firstCardStatus)
            $("#pCard2Name").text(p.secondCard)
            $("#pCard1Status").text(p.secondCardStatus)
        }

        //Updates the 'other players'
        function updateOtherPlayersView(payload) {
            var otherPlayers = Object.keys(payload.gameState.players)
                .filter(key => key != playerId)
                .reduce((obj, key) => {
                    obj[key] = payload.gameState.players[key]
                    return obj
                }, {})
            
            var otherSection = $("#otherPlayers>div")
            otherSection.empty()
            console.log(otherPlayers)
            for(const id in otherPlayers) {
                const other = otherPlayers[id]
                otherSection.append(`<p>Name: ${other.name} 
                    Card1: ${other.firstCard}, 
                    StatusCard1: ${other.firstCardStatus}; 
                    Card2: ${other.secondCard} 
                    StatusCard2: ${other.secondCardStatus}; 
                    Coins: ${other.coins}</p>`)
            }
        }

        function updateTimer(time) {
            var timer = document.getElementById("roundTimer").textContent = time
        }

        class ActionPayload { 
            constructor(intent, to="") {
                this.id = socket.id
                this.intent = intent
                this.to = to
            }
        }

        var income = $("#income").on("click", function() {
            socket.emit('action', new ActionPayload("income"))
        })
        var foreign = $("#foreign").on("click", function() {
            socket.emit('action', new ActionPayload("foreign"))
        })
        var coup = $("#coup").on("click", function() {
            socket.emit('action', new ActionPayload("coup"))
        })
        var tax = $("#tax").on("click", function() {
            socket.emit('action', new ActionPayload("tax"))
        })
        var steal = $("#steal").on("click", function() {
            changeCoins(2)
            declareIntention("steal")
        })
        var assassinate = $("#assassinate").on("click", function() {
            declareIntention("assassinate")
        })
        var exchange = $("#exchange").on("click", function() {
        })

        //Declares the intention (String)
        function declareIntention(intention) {
            $("#playerSelector").css("display","block")
            $("#intention").text(intention)
        }

        //choose a player (steal, assassinate)
        function selectPlayer(identifier) {
            console.log("selected player", $(identifier).text());
            $("#playerSelector").css("display","none")

            socket.emit('action', 
                new ActionPayload("player", $("#intention").text(), $(identifier).text()))
        }

    </script>
</body>
</html>